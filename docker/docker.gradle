/*
Common docker commands

Containers: docker ps -a
Images: docker images
 */

task showDockerContainers(type: Exec) {
    group 'tunturi-docker-info'
    executable "docker"
    args('ps', '-a')
}

task showDockerImages(type: Exec) {
    group 'tunturi-docker-info'
    executable "docker"
    args('images')
}

/*
 Database Docker commands

 Build: docker build -f docker/db/Dockerfile -t db-docker .
 Run: docker run --name db-docker -d -p 10301:3306 db-docker
 Stop: docker stop db-docker
 Remove: docker rm -f db-docker
 */
task buildDatabaseDocker(type: Exec) {
    group 'tunturi-docker'
    executable "docker"
    args('build', '-f', "${projectDir}/docker/db/Dockerfile", '-t', 'db-docker', "${projectDir}/")
}

task runDatabaseDocker(type: Exec) {
    group 'tunturi-docker'
    executable "docker"
    args('run', '--name', 'db-docker', '-d', '-p', '10301:3306', 'db-docker')
}

runDatabaseDocker.doLast {
    exec {
        commandLine 'bash', "${projectDir}/docker/script/WaitForDatabase.sh"
    }
}

task stopDatabaseDocker(type: Exec) {
    group 'tunturi-docker'
    executable "docker"
    args('stop', 'db-docker')
}

task stopAndRemoveDatabaseDocker(type: Exec) {
    group 'tunturi-docker'
    executable "docker"
    args('rm', '-f', 'db-docker')
}

/*
 App Docker commands

 Build: docker build -f docker/app/Dockerfile -t app-docker .
 Run: docker run --name app-docker -d app-docker
 Stop: docker stop app-docker
 Remove: docker rm -f app-docker
 */
task buildAppDocker(type: Exec) {
    group 'tunturi-docker'
    executable "docker"
    args('build', '-f', "${projectDir}/docker/app/Dockerfile", '-t', 'app-docker', "--build-arg", "APP_VERSION=$project_version", "${projectDir}/")
}

task runAppDocker(type: Exec) {
    group 'tunturi-docker'
    executable "docker"
    args('run', '--name', 'app-docker', '-d', 'app-docker')
}

task stopAppDocker(type: Exec) {
    group 'tunturi-docker'
    executable "docker"
    args('stop', 'app-docker')
}

task stopAndRemoveAppDocker(type: Exec) {
    group 'tunturi-docker'
    executable "docker"
    args('rm', '-f', 'app-docker')
}

/*
Docker compose commands

Up: docker-compose -f docker/docker-compose.yml up -d
Down: docker-compose -f docker/docker-compose.yml down
 */
task orchestrateContainersUp(type: Exec) {
    group 'tunturi-docker-compose'
    executable "docker-compose"
    args('-f', "${projectDir}/docker/docker-compose.yml", 'up', '-d')
}

task orchestrateContainersDown(type: Exec) {
    group 'tunturi-docker-compose'
    executable "docker-compose"
    args('-f', "${projectDir}/docker/docker-compose.yml", 'down')
}

/*
Docker publish commands

login: docker login docker.pkg.github.com --username algalopez -p <TOKEN>
logout: docker logout docker.pkg.github.com
dbTag: docker tag db-docker docker.pkg.github.com/algalopez/tunturi/tunturi-db-docker:<PROJECT_VERSION>
appTag: docker tag app-docker docker.pkg.github.com/algalopez/tunturi/tunturi-app-docker:<PROJECT_VERSION>
bdPublish: docker push docker.pkg.github.com/algalopez/tunturi/tunturi-db-docker:<PROJECT_VERSION>
appPublish: docker push docker.pkg.github.com/algalopez/tunturi/tunturi-app-docker:<PROJECT_VERSION>
 */
task loginToRegistry(type: Exec) {
    group 'tunturi-docker-publish'
    executable "docker"
    args('login', 'docker.pkg.github.com', '--username', 'algalopez', '-p', System.getenv('REGISTRY_TOKEN'))
}

task logoutFromRegistry(type: Exec) {
    group 'tunturi-docker-publish'
    executable "docker"
    args('logout', "docker.pkg.github.com")
}

task createDatabaseTag(type: Exec) {
    group 'tunturi-docker-publish'
    executable "docker"
    args('tag', 'db-docker', "docker.pkg.github.com/algalopez/tunturi/tunturi-db-docker:${project_version}")
}

task createAppTag(type: Exec) {
    group 'tunturi-docker-publish'
    executable "docker"
    args('tag', 'app-docker', "docker.pkg.github.com/algalopez/tunturi/tunturi-app-docker:${project_version}")
}

task publishDatabaseImage(type: Exec) {
    group 'tunturi-docker-publish'
    executable "docker"
    args('push', "docker.pkg.github.com/algalopez/tunturi/tunturi-db-docker:${project_version}")
}

task publishAppImage(type: Exec) {
    group 'tunturi-docker-publish'
    executable "docker"
    args('push', "docker.pkg.github.com/algalopez/tunturi/tunturi-app-docker:${project_version}")
}
